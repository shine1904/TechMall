<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gi·ªè h√†ng - Tech Mall</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
   <!-- Top Notification -->
  <div class="topbar">
    <div class="container">
      <span>‚ö° Gi·∫£m ƒë·∫øn 50% | Freeship ƒë∆°n t·ª´ 500k | Tr·∫£ g√≥p 0%</span>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html" aria-label="Trang ch·ªß">
        <span class="logo-badge">Tech</span><span class="logo-text">Mall</span>
      </a>


      <form class="search-box" action="#" method="get" role="search" aria-label="T√¨m ki·∫øm">
        <input name="q" type="text" placeholder="B·∫°n mu·ªën t√¨m g√¨? (V√≠ d·ª•: iPhone 15, Galaxy S24...)" aria-label="√î t√¨m ki·∫øm">
        <button type="submit" aria-label="T√¨m ki·∫øm">üîç</button>
      </form>

      <nav class="quick-links">
        <a href="order.html" class="quick-item" aria-label="Tra c·ª©u ƒë∆°n h√†ng">üßæ ƒê∆°n h√†ng</a>
        <a href="cart.html" class="quick-item" aria-label="Gi·ªè h√†ng">üõí Gi·ªè h√†ng</a>
          <a href="login.html" id="btnAccount" class="quick-item" aria-label="T√†i kho·∫£n">üë§ T√†i kho·∫£n</a>

  <!-- Panel hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p -->
  <div id="userPanel" class="quick-item" style="display:none;">
  üë§ 
  <a id="userName" href="profile.html" style="text-decoration:none; color:inherit;"></a>
  <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
</div>
</nav>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const btnAccount = document.getElementById("btnAccount");
  const userPanel = document.getElementById("userPanel");
  const userName = document.getElementById("userName");
  const btnLogout = document.getElementById("btnLogout");

  if (user && user.full_name) {
    // ·∫®n n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "none";

    // Hi·ªán panel user
    if (userName) userName.textContent = user.full_name;
    if (userPanel) userPanel.style.display = "inline-block";
  } else {
    // N·∫øu kh√¥ng c√≥ user -> hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "inline-block";
    if (userPanel) userPanel.style.display = "none";
  }

  // ƒêƒÉng xu·∫•t
  if (btnLogout) {
    btnLogout.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });
  }
});
</script>
      <!-- Mobile drawer -->
      <nav class="drawer">
        <ul class="drawer-list">
          <li><a href="#">ƒêi·ªán tho·∫°i</a></li> 
          <li><a href="#">Laptop</a></li>
          <li><a href="#">Tablet</a></li>
          <li><a href="#">√Çm thanh</a></li>
          <li><a href="#">ƒê·ªìng h·ªì</a></li>
          <li><a href="#">Ph·ª• ki·ªán</a></li>
         
         
        </ul>
      </nav>
    </div>

    <!-- Category bar (desktop) -->
    <div class="category-bar">
      <div class="container cat-inner">
        <a href="showproduct1.html">ƒêi·ªán tho·∫°i</a>
        <a href="showproduct2.html">Laptop</a>
        <a href="showproduct3.html">ƒê·ªìng h·ªì</a>
        <a href="showproduct4.html">Ph·ª• ki·ªán</a>

      </div>
    </div>
  </header>
<main class="cart-container">
  <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>
   <div id="cartMessage"></div>

  <div class="cart-grid" id="cartGrid">
    <!-- render s·∫£n ph·∫©m b·∫±ng JS -->
  </div>

<div class="payment-method">
  <h4>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h4>
  <label>
    <input type="radio" name="method" value="cod"> Thanh to√°n khi nh·∫≠n h√†ng (COD)
  </label><br>
  
  <label>
    <input type="radio" name="method" value="paypal"> Thanh to√°n qua PayPal
  </label>
</div>

<button id="payBtn" class="btn btn-primary" data-total="0">Thanh to√°n</button>

</main> 


<script>
// cart.js
const API_BASE = "http://localhost/ecommerce_api/index.php/api";

//  T·∫°o placeholder image SVG th·ªëng nh·∫•t
function createPlaceholderImage(width = 150, height = 150, text = "No Image") {
  const svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${width}" height="${height}" fill="#f8f9fa"/>
    <text x="${width/2}" y="${height/2}" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#6c757d">${text}</text>
  </svg>`;
  return `data:image/svg+xml;base64,${btoa(svg)}`;
}

function formatCurrency(amount) {
  const n = Number(amount) || 0;
  return n.toLocaleString("vi-VN") + "‚Ç´";
}

async function safeParseResponse(res) {
  const out = { status: res.status, ok: res.ok, json: null, text: null };
  try {
    out.json = await res.clone().json();
  } catch (e) {
    try {
      out.text = await res.clone().text();
    } catch (tErr) {
      out.text = "<failed to read body>";
    }
    console.warn("[safeParseResponse] failed to parse json, status:", res.status, "body:", out.text, "error:", e);
  }
  return out;
}

async function loadCart() {
  try {
    const res = await fetch(`${API_BASE}/cart`, {
      headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    });
    const parsed = await safeParseResponse(res);
    const data = parsed.json || {};

    //  Debug logging
    console.log("Cart API response:", data);
    console.log("Items:", data.data?.items);

    const grid = document.getElementById("cartGrid");
    const summary = document.getElementById("cartTotal");
    const payBtn = document.getElementById("payBtn");

    if (!data.data || !data.data.items || data.data.items.length === 0) {
      grid.innerHTML = `<p style="text-align:center">Gi·ªè h√†ng tr·ªëng</p>`;
      if (summary) summary.textContent = "T·ªïng c·ªông: 0‚Ç´";
      if (payBtn) payBtn.style.display = "none";
      return;
    }

    grid.innerHTML = "";
    data.data.items.forEach(item => {
      // Debug t·ª´ng item
      console.log("Processing item:", item);
      console.log("Thumbnail:", item.thumbnail);
      console.log("Product ID:", item.product_id || item.id);

      const card = document.createElement("div");
      card.className = "accessory-card";

      // ==== render ·∫£nh v·ªõi router backend  ====
      let thumb = Array.isArray(item.thumbnail) ? item.thumbnail[0] : item.thumbnail;
      const pid = item.product_id || item.id;

      // Accept absolute URLs directly
      let imgUrl = "";
      if (thumb) {
        if (/^https?:\/\//i.test(thumb)) {
          // Already full URL from API
          imgUrl = thumb;
        } else if (thumb.startsWith("/api/")) {
          // Relative API path
          imgUrl = `http://localhost/ecommerce_api/index.php${thumb}`;
        } else {
          // Filename only - use API route
          imgUrl = `http://localhost/ecommerce_api/index.php/api/images/products/${pid}/${thumb}`;
        }
      } else {
        imgUrl = ""; // No fallback - let frontend handle
      }

      console.log("Final image URL:", imgUrl);

      // ‚úÖ T·∫°o img element ri√™ng ƒë·ªÉ x·ª≠ l√Ω l·ªói t·ªët h∆°n
      const img = document.createElement("img");
      img.src = imgUrl || createPlaceholderImage();
      img.onerror = () => { 
        console.error("·∫¢nh l·ªói:", imgUrl, "cho s·∫£n ph·∫©m:", item.product_name);
        img.onerror = null; 
        img.src = createPlaceholderImage();
      };
      img.alt = item.product_name || "";
      img.style.width = "150px";
      
      // T·∫°o ph·∫ßn c√≤n l·∫°i c·ªßa card
      card.innerHTML = `
        <h3>${item.product_name}</h3>
        <p class="price">${formatCurrency(item.price)}</p>
        <div class="qty-box">
          <span class="qty-label">S·ªë l∆∞·ª£ng:</span>
          <button type="button" class="qty-btn" data-action="minus" data-id="${item.id}">‚àí</button>
          <input type="number" id="qty-${item.id}" value="${item.quantity}" min="1" data-id="${item.id}" class="qty-input">
          <button type="button" class="qty-btn" data-action="plus" data-id="${item.id}">+</button>
        </div>
        <p class="line-total">T·ªïng: ${formatCurrency(item.price * item.quantity)}</p>
        <div class="actions">
          <button class="btn btn-outline" data-id="${item.id}">X√≥a</button>
        </div>
      `;
      
      // Th√™m img v√†o ƒë·∫ßu card
      card.insertBefore(img, card.firstChild);

      grid.appendChild(card);
    });

    if (summary) summary.textContent = "T·ªïng c·ªông: " + formatCurrency(data.data.total);
    if (payBtn) {
      payBtn.dataset.total = data.data.total;
      payBtn.style.display = "block";
    }

    attachCartEvents();

  } catch (err) {
    console.error("L·ªói load gi·ªè h√†ng:", err);
  }
}

function attachCartEvents() {
  document.querySelectorAll(".qty-input").forEach(input => {
    input.addEventListener("change", async function () {
      const itemId = this.dataset.id;
      const quantity = parseInt(this.value);
      if (isNaN(quantity) || quantity < 1) { this.value = 1; return; }
      await fetch(`${API_BASE}/cart/${itemId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ quantity })
      });
      loadCart();
    });
  });

  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = this.dataset.id;
      const action = this.dataset.action;
      const input = document.getElementById(`qty-${id}`);
      let val = parseInt(input.value) || 1;
      val = action === 'plus' ? val + 1 : Math.max(1, val - 1);
      input.value = val;
      await fetch(`${API_BASE}/cart/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ quantity: val })
      });
      loadCart();
    });
  });

  document.querySelectorAll(".actions .btn-outline").forEach(btn => {
    btn.addEventListener("click", async function () {
      const itemId = this.dataset.id;
      if (!confirm("X√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) return;
      await fetch(`${API_BASE}/cart/${itemId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
      });
      loadCart();
    });
  });

  const payBtn = document.querySelector("#payBtn");
  if (payBtn) {
    payBtn.addEventListener("click", async function () {
      const total = this.dataset.total || 0;
      const method = document.querySelector("input[name='method']:checked")?.value;
      if (!method) { alert("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n"); return; }

      const orderId = await createOrder(total, method);
      if (!orderId) return;

      window.location.href = `payment.html?order_id=${orderId}&price=${total}&method=${method}`;
    });
  }
}

async function createOrder(total, method) {
  const token = localStorage.getItem("token");
  if (!token) { alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); return null; }

  const cartRes = await fetch(`${API_BASE}/cart`, { headers: { "Authorization": "Bearer " + token } });
  const cartParsed = await safeParseResponse(cartRes);
  const items = cartParsed.json?.data?.items || [];

  let userProfile = {};
  try {
    const profileRes = await fetch(`${API_BASE}/user/profile`, {
      headers: { "Authorization": "Bearer " + token }
    });
    const profileParsed = await safeParseResponse(profileRes);
    if (profileParsed.ok && profileParsed.json?.success) {
      userProfile = profileParsed.json.data;
      localStorage.setItem("user", JSON.stringify(userProfile));
    } else {
      userProfile = JSON.parse(localStorage.getItem("user")) || {};
    }
  } catch (err) {
    userProfile = JSON.parse(localStorage.getItem("user")) || {};
  }

  const orderData = {
    items: items.map(i => ({ product_id: i.product_id, quantity: i.quantity, price: i.price })),
    payment_method: method,
    total: Number(total),
    fullname: userProfile.full_name || userProfile.fullname || "",
    email: userProfile.email || "",
    phone: userProfile.phone || "",
    address: userProfile.address || "",
    note: "",
    payment_status: "pending"
  };

  const res = await fetch(`${API_BASE}/orders`, {
    method: "POST",
    headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
    body: JSON.stringify(orderData)
  });

  const parsed = await safeParseResponse(res);
  const data = parsed.json || {};
  if (parsed.ok && data.success) {
    return data.data.order_id;
  } else {
    alert(data.message || parsed.text || "Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒë∆°n h√†ng!");
    return null;
  }
}

// X·ª≠ l√Ω sau khi thanh to√°n
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const status = params.get("status");
  const orderId = params.get("order_id");

  if (status === "success" && orderId) {
    const msgContainer = document.getElementById("cartMessage");
    if (msgContainer) {
      msgContainer.innerHTML = `
        <div class="success-message" 
             style="padding:12px; margin-bottom:15px; background:#d4edda; color:#155724; border:1px solid #c3e6cb; border-radius:6px;">
          üéâ Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng <strong>#${orderId}</strong> ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.
        </div>
      `;
    }

    try {
      const token = localStorage.getItem("token");
      const res = await fetch(`${API_BASE}/cart`, { headers: { "Authorization": "Bearer " + token } });
      const parsed = await safeParseResponse(res);
      const items = parsed.json?.data?.items || [];

      // x√≥a t·ª´ng item
      await Promise.all(items.map(item =>
        fetch(`${API_BASE}/cart/${item.id}`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + token }
        })
      ));

      localStorage.removeItem("cart");
    } catch (err) {
      console.error("L·ªói clear gi·ªè h√†ng:", err);
    }

    await loadCart();
    window.history.replaceState({}, document.title, "cart.html");
  } else if (status === "cancelled" && orderId) {
    // X·ª≠ l√Ω khi thanh to√°n b·ªã h·ªßy - kh√¥i ph·ª•c gi·ªè h√†ng
    const msgContainer = document.getElementById("cartMessage");
    if (msgContainer) {
      msgContainer.innerHTML = `
        <div class="warning-message" 
             style="padding:12px; margin-bottom:15px; background:#fff3cd; color:#856404; border:1px solid #ffeaa7; border-radius:6px;">
          ‚ö†Ô∏è Thanh to√°n ƒë√£ b·ªã h·ªßy cho ƒë∆°n h√†ng <strong>#${orderId}</strong>. Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c.
        </div>
      `;
    }

    try {
      // Kh√¥i ph·ª•c gi·ªè h√†ng t·ª´ ƒë∆°n h√†ng b·ªã h·ªßy
      const token = localStorage.getItem("token");
      const res = await fetch(`${API_BASE}/orders/${orderId}/restore-cart`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (res.ok) {
        console.log("ƒê√£ kh√¥i ph·ª•c gi·ªè h√†ng t·ª´ ƒë∆°n h√†ng b·ªã h·ªßy");
      }
    } catch (err) {
      console.error("L·ªói kh√¥i ph·ª•c gi·ªè h√†ng:", err);
    }

    await loadCart();
    window.history.replaceState({}, document.title, "cart.html");
  } else {
    loadCart();
  }
});
</script>










  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <a class="logo footer-logo" href="#"><span class="logo-badge">Tech</span><span class="logo-text">Mall</span></a>
        <p class="muted">¬© 2025 TechMall. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        <p class="muted">Hotline: 1800 0000 (Mi·ªÖn ph√≠)</p>
      </div>
      <div>
        <h4>H·ªó tr·ª£ kh√°ch h√†ng</h4>
        <ul class="footer-list">
          <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
          <li><a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
          <li><a href="#">Ch√≠nh s√°ch b·∫£o h√†nh</a></li>
          <li><a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
        </ul>
      </div>
      <div>
        <h4>V·ªÅ TechMall</h4>
        <ul class="footer-list">
          <li><a href="#">Gi·ªõi thi·ªáu</a></li>
          <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
          <li><a href="#">H·ªá th·ªëng c·ª≠a h√†ng</a></li>
        </ul>
      </div>
      <div>
        <h4>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h4>
        <div class="socials">
          <a href="#" aria-label="Facebook">üåê</a>
          <a href="#" aria-label="YouTube">‚ñ∂Ô∏è</a>
          <a href="#" aria-label="Zalo">üí¨</a>
        </div>
      </div>
    </div>
  </footer>


  <!-- Overlay for mobile drawer -->
  <label class="overlay" for="navCheck" aria-hidden="true"></label>
</body>
</html>
