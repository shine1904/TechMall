<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giá» hÃ ng - Tech Mall</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
   <!-- Top Notification -->
  <div class="topbar">
    <div class="container">
      <span>âš¡ Giáº£m Ä‘áº¿n 50% | Freeship Ä‘Æ¡n tá»« 500k | Tráº£ gÃ³p 0%</span>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html" aria-label="Trang chá»§">
        <span class="logo-badge">Tech</span><span class="logo-text">Mall</span>
      </a>


      <form class="search-box" action="#" method="get" role="search" aria-label="TÃ¬m kiáº¿m">
        <input name="q" type="text" placeholder="Báº¡n muá»‘n tÃ¬m gÃ¬? (VÃ­ dá»¥: iPhone 15, Galaxy S24...)" aria-label="Ã” tÃ¬m kiáº¿m">
        <button type="submit" aria-label="TÃ¬m kiáº¿m">ğŸ”</button>
      </form>

      <nav class="quick-links">
        <a href="#" class="quick-item" aria-label="Tra cá»©u Ä‘Æ¡n hÃ ng">ğŸ§¾ ÄÆ¡n hÃ ng</a>
        <a href="cart.html" class="quick-item" aria-label="Giá» hÃ ng">ğŸ›’ Giá» hÃ ng</a>
          <a href="login.html" id="btnAccount" class="quick-item" aria-label="TÃ i khoáº£n">ğŸ‘¤ TÃ i khoáº£n</a>

  <!-- Panel hiá»‡n khi Ä‘Ã£ Ä‘Äƒng nháº­p -->
  <div id="userPanel" class="quick-item" style="display:none;">
  ğŸ‘¤ 
  <a id="userName" href="profile.html" style="text-decoration:none; color:inherit;"></a>
  <button id="btnLogout">ÄÄƒng xuáº¥t</button>
</div>
</nav>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const btnAccount = document.getElementById("btnAccount");
  const userPanel = document.getElementById("userPanel");
  const userName = document.getElementById("userName");
  const btnLogout = document.getElementById("btnLogout");

  if (user && user.full_name) {
    // áº¨n nÃºt Ä‘Äƒng nháº­p
    if (btnAccount) btnAccount.style.display = "none";

    // Hiá»‡n panel user
    if (userName) userName.textContent = user.full_name;
    if (userPanel) userPanel.style.display = "inline-block";
  } else {
    // Náº¿u khÃ´ng cÃ³ user -> hiá»ƒn thá»‹ nÃºt Ä‘Äƒng nháº­p
    if (btnAccount) btnAccount.style.display = "inline-block";
    if (userPanel) userPanel.style.display = "none";
  }

  // ÄÄƒng xuáº¥t
  if (btnLogout) {
    btnLogout.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });
  }
});
</script>
      <!-- Mobile drawer -->
      <nav class="drawer">
        <ul class="drawer-list">
          <li><a href="#">Äiá»‡n thoáº¡i</a></li> 
          <li><a href="#">Laptop</a></li>
          <li><a href="#">Tablet</a></li>
          <li><a href="#">Ã‚m thanh</a></li>
          <li><a href="#">Äá»“ng há»“</a></li>
          <li><a href="#">Phá»¥ kiá»‡n</a></li>
         
         
        </ul>
      </nav>
    </div>

    <!-- Category bar (desktop) -->

<!-- Edit Order Modal (moved to page bottom) -->
    <div class="category-bar">
      <div class="container cat-inner">
        <a href="showproduct1.html">Äiá»‡n thoáº¡i</a>
        <a href="showproduct2.html">Laptop</a>
        <a href="showproduct3.html">Äá»“ng há»“</a>
        <a href="showproduct4.html">Phá»¥ kiá»‡n</a>

      </div>
    </div>
  </header>
<main class="orders-container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h2>
    <button onclick="loadOrders();" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
      ğŸ”„ Refresh
    </button>
  </div>
  <table id="orders-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Há» vÃ  tÃªn</th>
        <th>SÄT</th>
        <th>Äá»‹a chá»‰</th>
        <th>PhÆ°Æ¡ng thá»©c</th>
        <th>TT Thanh toÃ¡n</th>
        <th>Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng </th>
        <th>Tá»•ng tiá»n</th>
        <th>NgÃ y táº¡o</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>



<script>
const API_BASE = "http://localhost/ecommerce_api/index.php/api";

let _ordersCache = [];

async function loadOrders() {
  const token = localStorage.getItem("token");
  let role = localStorage.getItem("role"); // "admin" hoáº·c "user"

  try {
    if (!role) {
      const stored = JSON.parse(localStorage.getItem("user") || "null");
      if (stored) {
        // Náº¿u backend tráº£ vá» role trá»±c tiáº¿p
        if (stored.role) role = stored.role;

        // Kiá»ƒm tra máº£ng roles
        if (!role && Array.isArray(stored.roles)) {
          if (stored.roles.includes("super_admin") || stored.roles.includes("order_admin")) {
            role = "admin";
          }
        } 

        // Kiá»ƒm tra flag cÅ©
        if (!role && (stored.is_admin === true || stored.isAdmin === true)) {
          role = "admin";
        }
      }
    }
  } catch (e) {
    console.debug("[orders] cannot parse local user for role", e);
  }

  role = (role || "user").toString().toLowerCase();
  console.debug("[orders] role resolved to", role);

  if (!token) {
    console.error("âŒ [loadOrders] No token found!");
    alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
    window.location.href = "login.html";
    return;
  }
  

  try {
    const res = await fetch(`${API_BASE}/orders?t=${Date.now()}`, {
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
        "Cache-Control": "no-cache",
        "Pragma": "no-cache"
      },
    });


    if (!res.ok) {
      console.error("âŒ [loadOrders] API request failed:", res.status, res.statusText);
      alert("KhÃ´ng táº£i Ä‘Æ°á»£c Ä‘Æ¡n hÃ ng (HTTP " + res.status + ")");
      return;
    }

    const rawBody = await res.text();
    
    let result;
    try {
      result = JSON.parse(rawBody);
    } catch (e) {
      console.error("âŒ [loadOrders] failed to parse JSON, raw body:", rawBody);
      alert("Lá»—i server khi táº£i Ä‘Æ¡n hÃ ng. Kiá»ƒm tra console.");
      return;
    }

    let orders = [];
    
    if (Array.isArray(result)) {
      orders = result;
    } else if (result && Array.isArray(result.data)) {
      orders = result.data;
    } else if (result && result.success && Array.isArray(result.orders)) {
      orders = result.orders;
    } else if (result && result.success && Array.isArray(result.data?.orders)) {
      orders = result.data.orders;
    } else {
      console.error("âŒ [loadOrders] unexpected response shape", result);
      alert("KhÃ´ng thá»ƒ hiá»ƒu dá»¯ liá»‡u Ä‘Æ¡n hÃ ng tá»« server.");
      return;
    }

    _ordersCache = orders;
    console.debug("[orders] fetched", orders);

    const table = document.querySelector("#orders-table");
    
    const tbody = document.querySelector("#orders-table tbody");
    
    if (!table) {
      console.error("âŒ [loadOrders] Table not found!");
      return;
    }
    
    if (!tbody) {
      console.error("âŒ [loadOrders] Table body not found!");
      return;
    }
    
    tbody.innerHTML = "";

    if (orders.length === 0) {
      console.log("ğŸ“­ [loadOrders] No orders to display");
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng</td></tr>`;
      return;
    }
    

   orders.forEach((o, index) => {
  const tr = document.createElement("tr");
  tr.dataset.orderId = o.id;
  tr.innerHTML = `
    <td>${o.id}</td>
    <td>${o.fullname || "-"}</td>
    <td>${o.phone || "-"}</td>
    <td>${o.address || "-"}</td>
    <td>${o.payment_method || "-"}</td>
    <td>${o.payment_status || "-"}</td>
    <td>${o.status || "-"}</td>
    <td>${new Intl.NumberFormat("vi-VN").format(Number(o.total) || 0)}â‚«</td>
    <td>${o.created_at ? new Date(o.created_at).toLocaleString("vi-VN") : "-"}</td>
    <td class="actions"></td>
  `;

  const actionsCell = tr.querySelector(".actions");
  const paymentStatus = String(o.payment_status || "").toLowerCase();
  const status = String(o.status || "").toLowerCase();
  const method = String(o.payment_method || "").toLowerCase();

  // Kiá»ƒm tra thá»i gian 1 giá»
  const orderTime = new Date(o.created_at).getTime();
  const currentTime = new Date().getTime();
  const hourDiff = (currentTime - orderTime) / (1000 * 60 * 60); // Convert to hours
  const canEditShipping = hourDiff <= 1; // CÃ³ thá»ƒ sá»­a shipping trong vÃ²ng 1 giá»

  const isCanceled = paymentStatus === "failed" && status === "cancelled";

  if (isCanceled) {
    actionsCell.innerHTML = `<span class="muted"> ÄÆ¡n Ä‘Ã£ há»§y</span>`;
  } else if (role === "user") {
    if (status === "cancel_request") {
      actionsCell.innerHTML = `<span> Äang chá» xÃ¡c nháº­n há»§y</span>`;
    } else if (status === "pending") {
      if (method === "cod") {
        if (canEditShipping) {
          actionsCell.innerHTML = `
            <button class="order-btn order-btn--ghost order-btn--sm" onclick="editShipping(${o.id})">âœï¸ Sá»­a shipping</button>
            <button class="order-btn order-btn--danger order-btn--sm" id="cancel-btn-${o.id}" onclick="requestCancel(${o.id})">âŒ Há»§y Ä‘Æ¡n</button>
          `;
        } else {
          actionsCell.innerHTML = `<span class="muted"> ÄÃ£ quÃ¡ thá»i gian chá»‰nh sá»­a</span>`;
        }
      } else if (method === "paypal") {
        if (canEditShipping) {
          actionsCell.innerHTML = `
           <button class="order-btn order-btn--primary order-btn--sm"
    onclick="continuePayment(${o.id})">
     Tiáº¿p tá»¥c thanh toÃ¡n
  </button>

            <button class="order-btn order-btn--ghost order-btn--sm" onclick="editShipping(${o.id})"> Sá»­a Ä‘á»‹a chá»‰</button>
            <button class="order-btn order-btn--danger order-btn--sm" id="cancel-btn-${o.id}" onclick="requestCancel(${o.id})"> Há»§y Ä‘Æ¡n</button>
          `;
        } else {
          actionsCell.innerHTML = `
            <span class="muted"> Vui lÃ²ng chá» nháº­n hÃ ng</span>
          `;
        }
      }
    } else if (status === "confirmed" && paymentStatus === "paid") {
      // PayPal paid orders: hiá»ƒn thá»‹ nÃºt sá»­a shipping náº¿u trong vÃ²ng 1 giá»
      if (canEditShipping && method === "paypal") {
        actionsCell.innerHTML = `
          <button class="order-btn order-btn--ghost order-btn--sm" onclick="editShipping(${o.id})"> Sá»­a Ä‘á»‹a chá»‰</button>
          <button class="order-btn order-btn--ghost order-btn--sm" id="cancel-btn-${o.id}" onclick="requestCancel(${o.id})">YÃªu cáº§u há»§y</button>
        `;
      } else {
        actionsCell.innerHTML = `<span class="muted"> ÄÃ£ quÃ¡ thá»i gian chá»‰nh sá»­a</span>`;
      }
    } else {
      actionsCell.innerHTML = `<span>-</span>`;
    }
  } else if (role === "admin") {
    // Admin chá»‰ cÃ³ thá»ƒ xÃ¡c nháº­n há»§y Ä‘Æ¡n hÃ ng, khÃ´ng thá»ƒ tá»± há»§y hoáº·c sá»­a shipping
    if (status === "cancel_request") {
      actionsCell.innerHTML = `
        <button class="order-btn order-btn--primary order-btn--sm" onclick="confirmCancel(${o.id})"> XÃ¡c nháº­n há»§y</button>
      `;
    } else {
      actionsCell.innerHTML = `<span class="muted">Chá»‰ cÃ³ thá»ƒ xÃ¡c nháº­n há»§y Ä‘Æ¡n</span>`;
    }
  }

  tbody.appendChild(tr); // QUAN TRá»ŒNG: thÃªm dÃ²ng nÃ y Ä‘á»ƒ render
});

    


} catch (err) {
    console.error(" [loadOrders] JS Error:", err);
    alert("KhÃ´ng táº£i Ä‘Æ°á»£c Ä‘Æ¡n hÃ ng (lá»—i JS)");
  }
}

// DOM ready
document.addEventListener("DOMContentLoaded", function() {
  loadOrders();
});


// ===== User actions =====
async function editShipping(orderId) {
  // Open modal and prefill with current order data from _ordersCache
  const modal = document.getElementById('editOrderModal');
  const editId = document.getElementById('editOrderId');
  const fn = document.getElementById('edit_fullname');
  const ph = document.getElementById('edit_phone');
  const addr = document.getElementById('edit_address');

  editId.value = orderId;
  const o = _ordersCache.find(x => String(x.id) === String(orderId)) || {};
  fn.value = o.fullname || o.full_name || o.name || "";
  ph.value = o.phone || o.mobile || "";
  addr.value = o.address || o.addr || "";

  modal.style.display = 'flex';

  // Hook up cancel
  document.getElementById('cancelEdit').onclick = () => { modal.style.display = 'none'; };

  // Submit handler
  document.getElementById('editOrderForm').onsubmit = async (ev) => {
    ev.preventDefault();
    const fullname = fn.value.trim();
    const phone = ph.value.trim();
    const address = addr.value.trim();
    const id = editId.value;
    try {
      await fetch(`${API_BASE}/orders/${id}`, {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ fullname, phone, address })
      });
      modal.style.display = 'none';
      loadOrders();
    } catch (err) {
      console.error('[editOrderForm] submit failed', err);
      alert('Lá»—i khi lÆ°u thay Ä‘á»•i');
    }
  };
}

async function requestCancel(orderId, actor = 'user') {
  const order = _ordersCache.find(x => String(x.id) === String(orderId)) || {};
  const payment_status = String(order.payment_status || '').toLowerCase();

  // XÃ¡c nháº­n hÃ nh Ä‘á»™ng
  if (actor === 'admin') {
    if (!confirm(`Admin xÃ¡c nháº­n há»§y Ä‘Æ¡n #${orderId}? HÃ nh Ä‘á»™ng nÃ y KHÃ”NG thá»ƒ hoÃ n tÃ¡c.`)) return;
  } else {
    if (payment_status === 'pending') {
      if (!confirm('Báº¡n muá»‘n há»§y Ä‘Æ¡n hÃ ng Ä‘ang chá» thanh toÃ¡n?')) return;
    } else if (payment_status === 'paid') {
      if (!confirm('ÄÆ¡n Ä‘Ã£ thanh toÃ¡n. Gá»­i yÃªu cáº§u há»§y tá»›i admin?')) return;
    } else {
      alert(`KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n (payment_status: ${payment_status})`);
      return;
    }
  }

  const btnIds = [`cancel-btn-${orderId}`, `admin-cancel-btn-${orderId}`];
  const btn = btnIds.map(id => document.getElementById(id)).find(x => x);
  if (btn) btn.disabled = true;

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE}/orders/${orderId}/user-update`, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ cancel: true, actor })
    });

    const raw = await res.text();
    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      console.error('[requestCancel] non-json response', raw);
      alert('Lá»—i server khi há»§y Ä‘Æ¡n. Kiá»ƒm tra console hoáº·c backend.');
      return;
    }

    if (res.ok && (data.success || data.status === 'ok')) {
      const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
      const idx = _ordersCache.findIndex(x => String(x.id) === String(orderId));

      // Admin khÃ´ng thá»ƒ tá»± há»§y Ä‘Æ¡n hÃ ng ná»¯a
      if (actor === 'admin') {
        alert('Admin khÃ´ng thá»ƒ tá»± há»§y Ä‘Æ¡n hÃ ng. Chá»‰ cÃ³ thá»ƒ xÃ¡c nháº­n há»§y Ä‘Æ¡n tá»« yÃªu cáº§u cá»§a user.');
        return;
      } else {
        if (payment_status === 'pending') {
          // Há»§y ngay
          if (idx !== -1) {
            _ordersCache[idx].status = 'cancelled';
            _ordersCache[idx].payment_status = 'failed';
          }
          alert('ÄÃ£ há»§y Ä‘Æ¡n.');
          if (row) row.querySelector('.actions').innerHTML = `<span> ÄÃ£ há»§y</span>`;
          loadOrders();
        } else if (payment_status === 'paid') {
          // Gá»­i yÃªu cáº§u há»§y
          if (idx !== -1) {
            _ordersCache[idx].status = 'cancel_request';
          }
          alert('YÃªu cáº§u há»§y Ä‘Ã£ Ä‘Æ°á»£c gá»­i.');
          if (row) row.querySelector('.actions').innerHTML = `<span> Äang chá» xÃ¡c nháº­n</span>`;
          loadOrders();
        }
      }
    } else {
      const msg = data?.message || data?.error || `HTTP ${res.status}`;
      alert(`KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n: ${msg}`);
    }
  } catch (err) {
    console.error('[requestCancel] failed', err);
    alert('Lá»—i khi gá»­i yÃªu cáº§u há»§y. Thá»­ láº¡i sau.');
  } finally {
    if (btn) btn.disabled = false;
  }
}


// ===== Admin actions =====
// Admin chá»‰ cÃ³ thá»ƒ xÃ¡c nháº­n há»§y Ä‘Æ¡n hÃ ng, khÃ´ng thá»ƒ sá»­a hoáº·c xÃ³a Ä‘Æ¡n hÃ ng

async function confirmCancel(orderId) {
  if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ¡c nháº­n há»§y Ä‘Æ¡n hÃ ng nÃ y?")) return;
  await fetch(`${API_BASE}/orders/${orderId}/confirm`, {
    method: "PUT",
    headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
  });
  loadOrders();
}
async function continuePayment(orderId) {
  try {
    const response = await fetch(`${API_BASE}/payment/${orderId}/continue`, {
      method: "GET",
      headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "KhÃ´ng thá»ƒ tiáº¿p tá»¥c thanh toÃ¡n");
    }
    
    const orderData = await response.json();
    
    // LÆ°u thÃ´ng tin Ä‘Æ¡n hÃ ng Ä‘á»ƒ tiáº¿p tá»¥c thanh toÃ¡n
    localStorage.setItem("continuePayment", JSON.stringify({
      id: orderId,
      total: orderData.total,
      address: orderData.address
    }));

    window.location.href = "payment.html?order_id=" + orderId + "&price=" + orderData.total + "&method=paypal";
  } catch (error) {
    console.error("Continue payment error:", error);
    alert("Lá»—i: " + error.message);
  }
}



document.addEventListener("DOMContentLoaded", loadOrders);

// Auto-refresh orders every 30 seconds
setInterval(() => {
  console.log(" Auto-refreshing orders...", new Date().toLocaleTimeString());
  loadOrders();
}, 30000);
</script>












      <footer>
   <footer class="footer">
    <div class="container footer-grid">
      <div>
        <a class="logo footer-logo" href="#"><span class="logo-badge">Tech</span><span class="logo-text">Mall</span></a>
        <p class="muted">Â© 2025 TechMall. Táº¥t cáº£ cÃ¡c quyá»n Ä‘Æ°á»£c báº£o lÆ°u.</p>
        <p class="muted">Hotline: 1800 0000 (Miá»…n phÃ­)</p>
      </div>
      <div>
        <h4>Há»— trá»£ khÃ¡ch hÃ ng</h4>
        <ul class="footer-list">
          <li><a href="#">Trung tÃ¢m trá»£ giÃºp</a></li>
          <li><a href="#">HÆ°á»›ng dáº«n mua hÃ ng</a></li>
          <li><a href="#">ChÃ­nh sÃ¡ch báº£o hÃ nh</a></li>
          <li><a href="#">ChÃ­nh sÃ¡ch Ä‘á»•i tráº£</a></li>
        </ul>
      </div>
      <div>
        <h4>Vá» TechMall</h4>
        <ul class="footer-list">
          <li><a href="#">Giá»›i thiá»‡u</a></li>
          <li><a href="#">Tuyá»ƒn dá»¥ng</a></li>
          <li><a href="#">Há»‡ thá»‘ng cá»­a hÃ ng</a></li>
        </ul>
      </div>
      <div>
        <h4>Káº¿t ná»‘i vá»›i chÃºng tÃ´i</h4>
        <div class="socials">
          <a href="#" aria-label="Facebook">ğŸŒ</a>
          <a href="#" aria-label="YouTube">â–¶ï¸</a>
          <a href="#" aria-label="Zalo">ğŸ’¬</a>
        </div>
      </div>
    </div>
  </footer>
</body>
</div>
<!-- Edit Order Modal (moved here so it's direct child of body) -->
<div id="editOrderModal" class="modal">
  <div class="modal-content">
    <h3>Sá»­a Ä‘á»‹a chá»‰ giao hÃ ng</h3>
    <form id="editOrderForm">
      <input type="hidden" id="editOrderId">
      <label for="edit_fullname">Há» vÃ  tÃªn</label>
      <input id="edit_fullname" type="text" required>
      <label for="edit_phone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
      <input id="edit_phone" type="tel" required>
      <label for="edit_address">Äá»‹a chá»‰</label>
      <input id="edit_address" type="text" required>
      <div class="modal-actions">
        <button type="button" id="cancelEdit" class="cancel">Há»§y</button>
        <button type="submit" class="save">LÆ°u</button>
      </div>
    </form>
  </div>
</div>
</body>