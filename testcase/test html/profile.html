<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng tin ng∆∞·ªùi d√πng - TechMall</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
   <header class="header">
    <div class="container header-inner" aria-label="Trang ch·ªß">
      <a class="logo" href="index.html">
        <span class="logo-badge">Tech</span><span class="logo-text">Mall</span>
      </a>

      

      <form class="search-box" action="#" method="get" role="search" aria-label="T√¨m ki·∫øm">
        <input name="q" type="text" placeholder="B·∫°n mu·ªën t√¨m g√¨? (V√≠ d·ª•: iPhone 15, Galaxy S24...)" aria-label="√î t√¨m ki·∫øm">
        <button type="submit" aria-label="T√¨m ki·∫øm">üîç</button>
      </form>

      <nav class="quick-links">
        <a href="#" class="quick-item" aria-label="Tra c·ª©u ƒë∆°n h√†ng">üßæ ƒê∆°n h√†ng</a>
        <a href="cart.html" class="quick-item" aria-label="Gi·ªè h√†ng">üõí Gi·ªè h√†ng</a>
         <a href="login.html" id="btnAccount" class="quick-item" aria-label="T√†i kho·∫£n">üë§ T√†i kho·∫£n</a>

  <!-- Panel hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p -->
  <div id="userPanel" class="quick-item" style="display:none;">
  üë§ 
  <a id="userName" href="profile.html" style="text-decoration:none; color:inherit;"></a>
  <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
</div>
</nav>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const btnAccount = document.getElementById("btnAccount");
  const userPanel = document.getElementById("userPanel");
  const userName = document.getElementById("userName");
  const btnLogout = document.getElementById("btnLogout");

  if (user && user.full_name) {
    // ·∫®n n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "none";

    // Hi·ªán panel user
    if (userName) userName.textContent = user.full_name;
    if (userPanel) userPanel.style.display = "inline-block";
  } else {
    // N·∫øu kh√¥ng c√≥ user -> hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "inline-block";
    if (userPanel) userPanel.style.display = "none";
  }

  // ƒêƒÉng xu·∫•t
  if (btnLogout) {
    btnLogout.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });
  }
});
</script>

     
      
    </div>

    <!-- Category bar (desktop) -->
     <div class="category-bar">
      <div class="container cat-inner">
        <a href="showproduct1.html">ƒêi·ªán tho·∫°i</a>
        <a href="showproduct2.html">Laptop</a>
        <a href="showproduct3.html">ƒê·ªìng h·ªì</a>
        <a href="showproduct4.html">Ph·ª• ki·ªán</a>

      </div>
    </div>
  </header>

  <!-- User Info Form -->
<section class="profile-page">
  <div class="profile-container">
    <h1>Th√¥ng tin ng∆∞·ªùi d√πng</h1>
    <form id="profileForm">
      
      <div class="form-group">
        <label for="full_name">H·ªç v√† t√™n</label>
        <input type="text" id="full_name" name="full_name" placeholder="Nh·∫≠p h·ªç v√† t√™n" required>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="Nh·∫≠p email" required>
      </div>

      <div class="form-group">
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="text" id="phone" name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
      </div>

      <div class="form-group">
        <label for="address">ƒê·ªãa ch·ªâ</label>
        <input type="text" id="address" name="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
      </div>
      <div class="form-group">
        <label for="current_password">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
        <input type="password" id="current_password" name="current_password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
      </div>

      <div class="form-group">
        <label for="password">M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
      </div>

      <div class="form-group">
        <label for="confirm_password">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="confirm_password" name="confirm_password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
      </div>

      <button type="submit" class="btn-primary">C·∫≠p nh·∫≠t</button>
    </form>
  </div>
</section>

</section>


  <!-- Footer -->


  <script>
// =========================
// Helpers
// =========================
function getAuthToken() {
  return localStorage.getItem("token");
}
function getUser() {
  return JSON.parse(localStorage.getItem("user"));
}
function setUser(user) {
  localStorage.setItem("user", JSON.stringify(user));
}
function authHeaders() {
  const token = getAuthToken();
  return {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + token
  };
}
function ensureLoggedIn() {
  const token = getAuthToken();
  if (!token) {
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem trang n√†y.");
    window.location.href = "login.html";
    return false;
  }
  return true;
}
function handleUnauthorized() {
  localStorage.clear();
  alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
  window.location.href = "login.html";
}

// =========================
// Load user info
// =========================
async function loadUserInfo() {
  if (!ensureLoggedIn()) return;

  const user = getUser();
  if (!user || !user.id) {
    alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin user. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
    window.location.href = "login.html";
    return;
  }

  try {
    const res = await fetch(`http://localhost/ecommerce_api/index.php/api/users/${user.id}`, {
      method: "GET",
      headers: authHeaders()
    });

    if (res.status === 401) return handleUnauthorized();

    const data = await res.json();
    console.log("User info:", data);

    if (data.success) {
      const u = data.data;
      document.getElementById("full_name").value = u.full_name || "";
      document.getElementById("email").value = u.email || "";
      document.getElementById("phone").value = u.phone || "";
      document.getElementById("address").value = u.address || "";
      setUser(u);
    } else {
      alert(data.message || "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.");
    }
  } catch (err) {
    console.error("L·ªói khi load user info:", err);
    alert("L·ªói k·∫øt n·ªëi khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.");
  }
}

// =========================
// Update user info
// =========================
document.getElementById("profileForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!ensureLoggedIn()) return;

  const user = getUser();
  if (!user || !user.id) {
    alert("Kh√¥ng t√¨m th·∫•y user. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
    window.location.href = "login.html";
    return;
  }

  const payload = {
    full_name: document.getElementById("full_name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim() || null,
    address: document.getElementById("address").value.trim() || null
  };

  const currentPwd = document.getElementById("current_password")?.value || "";
  const newPwd = document.getElementById("password")?.value || "";
  const confirmPwd = document.getElementById("confirm_password")?.value || "";

  // N·∫øu c√≥ nh·∫≠p m·∫≠t kh·∫©u m·ªõi th√¨ b·∫Øt bu·ªôc ki·ªÉm tra logic ƒë·ªïi m·∫≠t kh·∫©u
  if (newPwd || confirmPwd || currentPwd) {
    if (!currentPwd) {
      alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i.");
      return;
    }
    if (!newPwd) {
      alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi.");
      return;
    }
    if (newPwd !== confirmPwd) {
      alert("M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp.");
      return;
    }

    payload.current_password = currentPwd;
    payload.password = newPwd;
  }

  try {
    const res = await fetch(`http://localhost/ecommerce_api/index.php/api/users/${user.id}`, {
      method: "PUT",
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });

    if (res.status === 401) return handleUnauthorized();

    const result = await res.json();
    console.log("Update result:", result);

    if (res.ok && result.success) {
      alert("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");

      const currentUser = getUser() || {};
      const updatedUser = { ...currentUser, ...(result.data || payload) };
      setUser(updatedUser);

      // Reset m·∫≠t kh·∫©u sau khi ƒë·ªïi
      document.getElementById("current_password").value = "";
      document.getElementById("password").value = "";
      document.getElementById("confirm_password").value = "";
    } else {
      if (result.errors) {
        alert("L·ªói:\n" + Object.values(result.errors).join("\n"));
      } else {
        alert(result.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
      }
    }
  } catch (err) {
    console.error("L·ªói update:", err);
    alert("L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t th√¥ng tin.");
  }
});

// =========================
// Logout button
// =========================
const btnLogout = document.getElementById("btnLogout");
if (btnLogout) {
  btnLogout.addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
  });
}

// =========================
// Init
// =========================
document.addEventListener("DOMContentLoaded", loadUserInfo);
</script>


  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <a class="logo footer-logo" href="#"><span class="logo-badge">Tech</span><span class="logo-text">Mall</span></a>
        <p class="muted">¬© 2025 TechMall. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        <p class="muted">Hotline: 1800 0000 (Mi·ªÖn ph√≠)</p>
      </div>
      <div>
        <h4>H·ªó tr·ª£ kh√°ch h√†ng</h4>
        <ul class="footer-list">
          <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
          <li><a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
          <li><a href="#">Ch√≠nh s√°ch b·∫£o h√†nh</a></li>
          <li><a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
        </ul>
      </div>
      <div>
        <h4>V·ªÅ TechMall</h4>
        <ul class="footer-list">
          <li><a href="#">Gi·ªõi thi·ªáu</a></li>
          <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
          <li><a href="#">H·ªá th·ªëng c·ª≠a h√†ng</a></li>
        </ul>
      </div>
      <div>
        <h4>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h4>
        <div class="socials">
          <a href="#" aria-label="Facebook">üåê</a>
          <a href="#" aria-label="YouTube">‚ñ∂Ô∏è</a>
          <a href="#" aria-label="Zalo">üí¨</a>
        </div>
      </div>
    </div>
  </footer>


</body>
</html>
