<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="">
  <title>TechMall - Mua s·∫Øm ƒëi·ªán tho·∫°i, laptop, ph·ª• ki·ªán</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
</head>
<body>
  <!-- Top Notification -->
  <div class="topbar">
    <div class="container">
      <span>‚ö° Gi·∫£m ƒë·∫øn 50% | Freeship ƒë∆°n t·ª´ 500k | Tr·∫£ g√≥p 0%</span>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html">
        <span class="logo-badge">Tech</span><span class="logo-text">Mall</span>
      </a>

      

      <form class="search-box" action="#" method="get" role="search" aria-label="T√¨m ki·∫øm">
        <input name="q" type="text" placeholder="B·∫°n mu·ªën t√¨m g√¨? (V√≠ d·ª•: iPhone 15, Galaxy S24...)" aria-label="√î t√¨m ki·∫øm">
        <button type="submit" aria-label="T√¨m ki·∫øm">üîç</button>
      </form>

    <nav class="quick-links">
  <a href="#" class="quick-item" aria-label="Tra c·ª©u ƒë∆°n h√†ng">üßæ ƒê∆°n h√†ng</a>
  <a href="cart.html" class="quick-item" aria-label="Gi·ªè h√†ng">üõí Gi·ªè h√†ng</a>

  <!-- N√∫t m·∫∑c ƒë·ªãnh khi ch∆∞a ƒëƒÉng nh·∫≠p -->
  <a href="login.html" id="btnAccount" class="quick-item" aria-label="T√†i kho·∫£n">üë§ T√†i kho·∫£n</a>

  <!-- Panel hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p -->
  <div id="userPanel" class="quick-item" style="display:none;">
  üë§ 
  <a id="userName" href="profile.html" style="text-decoration:none; color:inherit;"></a>
  <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
</div>
</nav>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const btnAccount = document.getElementById("btnAccount");
  const userPanel = document.getElementById("userPanel");
  const userName = document.getElementById("userName");
  const btnLogout = document.getElementById("btnLogout");

  if (user && user.full_name) {
    // ·∫®n n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "none";

    // Hi·ªán panel user
    if (userName) userName.textContent = user.full_name;
    if (userPanel) userPanel.style.display = "inline-block";
  } else {
    // N·∫øu kh√¥ng c√≥ user -> hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p
    if (btnAccount) btnAccount.style.display = "inline-block";
    if (userPanel) userPanel.style.display = "none";
  }

  // ƒêƒÉng xu·∫•t
  if (btnLogout) {
    btnLogout.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });
  }
});
</script>



      <!-- Mobile drawer -->
      <nav class="drawer">
        <ul class="drawer-list">
          <li><a href="#">ƒêi·ªán tho·∫°i</a></li>
          <li><a href="#">Laptop</a></li>
          <li><a href="#">Tablet</a></li>
          <li><a href="#">√Çm thanh</a></li>
          <li><a href="#">ƒê·ªìng h·ªì</a></li>
          <li><a href="#">Ph·ª• ki·ªán</a></li>
         
         
        </ul>
      </nav>
    </div>

    <!-- Category bar (desktop) -->
    <div class="category-bar">
      <div class="container cat-inner">
        <a href="showproduct1.html">ƒêi·ªán tho·∫°i</a>
        <a href="showproduct2.html">Laptop</a>
        <a href="showproduct3.html">ƒê·ªìng h·ªì</a>
        <a href="showproduct4.html">Ph·ª• ki·ªán</a>

      </div>
    </div>
  </header>
   <style>
    .payment-container {
      max-width: var(--container, 800px);
      margin: 40px auto;
      padding: 0 16px;
      color: #fff;
    }
    .payment-box {
      background: linear-gradient(180deg,#0f1016,#0b0c10);
      border: 1px solid #212537;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    .payment-box h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: var(--brand, #0af);
    }
    .order-info {
      margin-bottom: 24px;
      font-size: 17px;
      font-weight: 600;
    }
    .order-info span {
      display: block;
      margin: 6px 0;
    }
    .methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 28px;
    }
    .method {
      background: #18191e;
      border: 1px solid #23263a;
      border-radius: 12px;
      padding: 14px 18px;
      cursor: pointer;
      transition: 0.2s;
    }
    .method:hover {
      border-color: var(--brand, #0af);
    }
    .method input {
      margin-right: 8px;
    }
    .pay-btn {
      background: var(--brand, #0af);
      color: var(--brand-ink, #000);
      border: none;
      padding: 14px 28px;
      border-radius: 999px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
      box-shadow: 0 2px 8px #0003;
    }
    .pay-btn:hover {
      background: #fff;
      color: #000;
      transform: translateY(-1px) scale(1.03);
    }
  </style>
</head>
<body>
  <!-- header c√≥ s·∫µn -->
<main class="payment-container">
  <div class="payment-box">
    <h2>X√°c nh·∫≠n thanh to√°n</h2>

    <div class="payment-content">
      <div class="order-info">
        <p><strong>M√£ ƒë∆°n h√†ng:</strong> <span id="order-id">---</span></p>
        <p><strong>T·ªïng ti·ªÅn:</strong> <span id="order-price">0‚Ç´</span></p>
        <p><strong>Ph∆∞∆°ng th·ª©c:</strong> <span id="order-method">---</span></p>
      </div>

      <form id="shipping-form">
        <label for="fullname">H·ªç v√† t√™n</label>
        <input type="text" id="fullname" name="fullname" required>

        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="tel" id="phone" name="phone" required>

        <label for="address">ƒê·ªãa ch·ªâ</label>
        <input type="text" id="address" name="address" required>

        <button type="submit">Thanh to√°n</button>
      </form>
    </div>
  </div>
</main>


<!-- PayPal SDK -->

<script>
// payment.js
const API_BASE = "http://localhost/ecommerce_api/index.php/api";
const params = new URLSearchParams(window.location.search);
const ORDER_ID = params.get("order_id");
const PRICE = params.get("price");
const METHOD = params.get("method"); // 'cod' | 'momo' | 'paypal'
const token = localStorage.getItem("token");

// Debug info
console.log("Payment page loaded with:", { ORDER_ID, PRICE, METHOD, token: token ? "present" : "missing" });

// üîí CSRF Manager
const CSRFManager = {
  getToken: () => {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
  },
  
  addToHeaders: (headers = {}) => {
    const csrfToken = CSRFManager.getToken();
    if (csrfToken) {
      headers['X-CSRF-Token'] = csrfToken;
    }
    return headers;
  }
};

// ==== PAGE LOAD ====
document.addEventListener("DOMContentLoaded", async () => {
  if (!ORDER_ID) {
    alert("Order ID missing");
    window.location.href = "/test html/cart.html";
    return;
  }

  // üîí SECURITY: Get CSRF token
  try {
    const csrfRes = await fetch(`${API_BASE}/csrf-token`, {
      method: "GET",
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (csrfRes.ok) {
      const csrfData = await csrfRes.json();
      if (csrfData.success && csrfData.data && csrfData.data.token) {
        document.querySelector('meta[name="csrf-token"]').setAttribute('content', csrfData.data.token);
      }
    }
  } catch (err) {
    console.warn("Could not get CSRF token:", err);
  }

  // hi·ªÉn th·ªã order basic
  document.getElementById("order-id").textContent = ORDER_ID;
  document.getElementById("order-price").textContent = PRICE ? Number(PRICE).toLocaleString("vi-VN") + "‚Ç´" : "0‚Ç´";
  document.getElementById("order-method").textContent = METHOD?.toUpperCase() || "---";

  // load order details
  try {
    const res = await fetch(`${API_BASE}/orders/${ORDER_ID}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json().catch(() => ({}));
    const order = data?.data || {};
    const localUser = JSON.parse(localStorage.getItem("user") || "{}");

    function pickField(obj, keys) {
      if (!obj) return "";
      for (const k of keys) {
        if (Object.prototype.hasOwnProperty.call(obj, k)) {
          const v = obj[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") return v;
        }
      }
      return "";
    }

    const phoneKeys = ["phone", "mobile", "phone_number"];
    const addressKeys = ["address", "addr", "address_line"];

    let fullnameVal = pickField(order, ["fullname","full_name"]) || pickField(localUser, ["full_name","fullname","name"]);
    let phoneVal    = pickField(order, phoneKeys) || pickField(localUser, phoneKeys);
    let addressVal  = pickField(order, addressKeys) || pickField(localUser, addressKeys);

    // fallback sang /users/me n·∫øu thi·∫øu
    if (!phoneVal || !addressVal) {
      try {
        const userRes = await fetch(`${API_BASE}/users/me`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!userRes.ok) {
          throw new Error(`HTTP ${userRes.status}: ${userRes.statusText}`);
        }
        
        const userJson = await userRes.json();
        if (userJson.success) {
          const u = userJson.data;
          if (!fullnameVal && u.full_name) fullnameVal = u.full_name;
          if (!phoneVal && u.phone) phoneVal = u.phone;
          if (!addressVal && u.address) addressVal = u.address;
        }
      } catch (e) {
        console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c user profile:", e);
      }
    }

    if (fullnameVal) document.getElementById("fullname").value = fullnameVal;
    if (phoneVal) document.getElementById("phone").value = phoneVal;
    if (addressVal) document.getElementById("address").value = addressVal;
  } catch (err) {
    console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c order:", err);
    alert("L·ªói t·∫£i th√¥ng tin ƒë∆°n h√†ng: " + err.message);
  }


  // ==== SUBMIT FORM ====
  document.getElementById("shipping-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fullname = document.getElementById("fullname").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    if (!fullname || !phone || !address) { alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin"); return; }

    // 1) confirm order
    try {
      const updateRes = await fetch(`${API_BASE}/orders/${ORDER_ID}/confirm`, {
        method: "PUT",
        headers: CSRFManager.addToHeaders({ 
          "Authorization": `Bearer ${token}`, 
          "Content-Type": "application/json" 
        }),
        body: JSON.stringify({ fullname, phone, address })
      });
      
      if (!updateRes.ok) {
        throw new Error(`HTTP ${updateRes.status}: ${updateRes.statusText}`);
      }
      
      const updateJson = await updateRes.json();
      if (!updateJson.success) {
        throw new Error(updateJson.message || "Failed to confirm order");
      }
    } catch (error) {
      console.error("Error confirming order:", error);
      alert("Kh√¥ng l∆∞u ƒë∆∞·ª£c th√¥ng tin giao h√†ng: " + error.message);
      return;
    }

    // 2) x·ª≠ l√Ω theo ph∆∞∆°ng th·ª©c
    if (METHOD === "cod") {
      try {
        const res = await fetch(`${API_BASE}/payment/${ORDER_ID}/cod`, {
          method: "POST",
          headers: CSRFManager.addToHeaders({ "Authorization": `Bearer ${token}` })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const r = await res.json();
        if (r.success) {
          window.location.href = `cart.html?status=success&order_id=${ORDER_ID}`;
        } else {
          throw new Error(r.message || "L·ªói x·ª≠ l√Ω COD");
        }
      } catch (error) {
        console.error("COD payment error:", error);
        alert("L·ªói x·ª≠ l√Ω COD: " + error.message);
      }
    } else if (METHOD === "momo") {
      try {
        const res = await fetch(`${API_BASE}/payment/${ORDER_ID}/momo`, {
          method: "POST",
          headers: CSRFManager.addToHeaders({ "Authorization": `Bearer ${token}` })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const r = await res.json();
        if (r.success) {
          if (r.data && r.data.payment_url) {
            window.location.href = r.data.payment_url;
          } else {
            window.location.href = `cart.html?status=success&order_id=${ORDER_ID}`;
          }
        } else {
          throw new Error(r.message || "L·ªói Momo");
        }
      } catch (error) {
        console.error("MoMo payment error:", error);
        alert("L·ªói Momo: " + error.message);
      }
    } else if (METHOD === "paypal") {
      try {
        const res = await fetch(`${API_BASE}/payment/${ORDER_ID}/paypal`, {
          method: "POST",
          headers: CSRFManager.addToHeaders({ "Authorization": `Bearer ${token}` })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const r = await res.json();
        if (r.success && r.data && r.data.payment_url) {
          window.location.href = r.data.payment_url;
        } else {
          throw new Error(r.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c PayPal order");
        }
      } catch (error) {
        console.error("PayPal payment error:", error);
        alert("L·ªói PayPal: " + error.message);
      }
    } else {
      alert("Ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng h·ª£p l·ªá");
    }
  });

  // ==== HI·ªÇN TH·ªä TH√îNG B√ÅO TR√äN CART ====
  const status = params.get("status");
  const orderId = params.get("order_id");
  if (status === "success" && orderId) {
    alert(`Thanh to√°n th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${orderId}`);
    localStorage.removeItem("cart");

    const cartContainer = document.getElementById("cart-container");
    if (cartContainer) {
      cartContainer.innerHTML = `
        <div class="success-message">
          üéâ Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng #${orderId} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.
        </div>
      `;
    }

    // xo√° query kh·ªèi url
    window.history.replaceState({}, document.title, "cart.html");
  }
});
</script>







  
<footer class="footer">
    <div class="container footer-grid">
      <div>
        <a class="logo footer-logo" href="#"><span class="logo-badge">Tech</span><span class="logo-text">Mall</span></a>
        <p class="muted">¬© 2025 TechMall. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        <p class="muted">Hotline: 1800 0000 (Mi·ªÖn ph√≠)</p>
      </div>
      <div>
        <h4>H·ªó tr·ª£ kh√°ch h√†ng</h4>
        <ul class="footer-list">
          <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
          <li><a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
          <li><a href="#">Ch√≠nh s√°ch b·∫£o h√†nh</a></li>
          <li><a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
        </ul>
      </div>
      <div>
        <h4>V·ªÅ TechMall</h4>
        <ul class="footer-list">
          <li><a href="#">Gi·ªõi thi·ªáu</a></li>
          <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
          <li><a href="#">H·ªá th·ªëng c·ª≠a h√†ng</a></li>
        </ul>
      </div>
      <div>
        <h4>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h4>
        <div class="socials">
          <a href="#" aria-label="Facebook">üåê</a>
          <a href="#" aria-label="YouTube">‚ñ∂Ô∏è</a>
          <a href="#" aria-label="Zalo">üí¨</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Overlay for mobile drawer -->
  <label class="overlay" for="navCheck" aria-hidden="true"></label>
</body>
</html>
